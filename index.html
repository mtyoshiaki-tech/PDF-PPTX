<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
　　<meta name="robots" content="noindex"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF to PPTX Converter</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    
    <!-- PptxGenJS -->
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

    <style>
        @keyframes aurora-1 {
          0%, 100% { transform: translate(0, 0) scale(1); }
          50% { transform: translate(20px, -20px) scale(1.1); }
        }
        @keyframes aurora-2 {
          0%, 100% { transform: translate(0, 0) scale(1); }
          50% { transform: translate(-20px, 10px) scale(1.2); }
        }
        @keyframes fade-in-up {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-aurora-1 { animation: aurora-1 10s infinite ease-in-out; }
        .animate-aurora-2 { animation: aurora-2 12s infinite ease-in-out; }
        .animate-fade-in-up { animation: fade-in-up 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        
        body { font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 min-h-screen flex flex-col items-center justify-center overflow-hidden p-6 selection:bg-indigo-500/30 selection:text-indigo-100">

    <!-- Background Effects -->
    <div class="fixed inset-0 pointer-events-none">
        <div id="bg-blob-1" class="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] rounded-full blur-[100px] animate-aurora-1 transition-colors duration-700 bg-sky-600/10"></div>
        <div id="bg-blob-2" class="absolute bottom-[-10%] right-[-10%] w-[50%] h-[50%] rounded-full blur-[100px] animate-aurora-2 transition-colors duration-700 bg-indigo-600/10"></div>
    </div>

    <div class="w-full max-w-2xl space-y-8 relative z-10">
        
        <!-- Header -->
        <div class="text-center space-y-4 pt-4 transition-all duration-500">
            <div class="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-white/5 border border-white/10 shadow-[0_0_15px_rgba(255,255,255,0.05)] mb-2 animate-fade-in-up backdrop-blur-md">
                <i id="header-icon" data-lucide="layers" class="w-3.5 h-3.5 text-sky-400"></i>
                <span id="header-badge" class="text-[11px] uppercase tracking-[0.2em] font-bold text-sky-400/90">Standard Mode</span>
            </div>
            
            <h1 class="text-3xl md:text-5xl font-extrabold tracking-tight text-white leading-tight drop-shadow-2xl animate-fade-in-up" style="animation-delay: 0.1s;">
                PDFを<span id="header-gradient" class="text-transparent bg-clip-text bg-gradient-to-r transition-all duration-700 from-sky-400 to-indigo-200">PPTX</span>へ。
            </h1>
        </div>

        <!-- Main Card Container -->
        <div class="transition-all duration-500">
            
            <!-- VIEW: IDLE (Upload & Quality Select) -->
            <div id="view-idle" class="bg-white/5 backdrop-blur-2xl rounded-[2.5rem] shadow-[0_8px_32px_0_rgba(0,0,0,0.36)] border border-white/10 overflow-hidden relative animate-fade-in-up" style="animation-delay: 0.3s;">
                
                <!-- Quality Selector -->
                <div class="flex items-center justify-center gap-2 p-6 border-b border-white/5 bg-black/10">
                    <button onclick="setQuality('low')" id="btn-q-low" class="flex items-center gap-2 px-4 py-2 rounded-full text-xs font-bold transition-all border bg-white/5 text-slate-500 border-transparent hover:bg-white/10">
                        <i data-lucide="signal-low" class="w-3.5 h-3.5"></i> 低 (軽量)
                    </button>
                    <button onclick="setQuality('medium')" id="btn-q-medium" class="flex items-center gap-2 px-4 py-2 rounded-full text-xs font-bold transition-all border bg-sky-500/20 text-sky-300 border-sky-500/30">
                        <i data-lucide="signal-medium" class="w-3.5 h-3.5"></i> 中 (標準)
                    </button>
                    <button onclick="setQuality('high')" id="btn-q-high" class="flex items-center gap-2 px-4 py-2 rounded-full text-xs font-bold transition-all border bg-white/5 text-slate-500 border-transparent hover:bg-white/10">
                        <i data-lucide="signal-high" class="w-3.5 h-3.5"></i> 高 (最高)
                    </button>
                </div>

                <!-- Upload Click Area -->
                <div 
                    class="relative p-12 text-center cursor-pointer group hover:bg-white/5 transition-all duration-300"
                    onclick="document.getElementById('file-input').click()"
                >
                    <input type="file" id="file-input" class="hidden" accept="application/pdf" onchange="handleFileSelect(this)">
                    
                    <div class="relative z-10 flex flex-col items-center gap-6">
                        <div id="upload-icon-container" class="w-24 h-24 rounded-3xl bg-slate-800/50 border border-white/10 flex items-center justify-center shadow-2xl transition-all duration-500 group-hover:scale-105 group-hover:bg-slate-800/80 text-sky-400 group-hover:shadow-sky-500/20">
                            <i data-lucide="mouse-pointer-click" class="w-10 h-10"></i>
                        </div>
                        <div class="space-y-3">
                            <p class="text-2xl font-bold text-slate-200 group-hover:text-white transition-colors">
                                ファイルを選択
                            </p>
                            <div id="upload-badge" class="px-6 py-2 rounded-full border bg-opacity-10 text-sm font-medium inline-block transition-all border-sky-500/30 bg-sky-500 text-sky-300">
                                クリックしてPDFを選ぶ
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: PROCESSING -->
            <div id="view-processing" class="hidden bg-white/5 backdrop-blur-2xl rounded-[2.5rem] shadow-[0_8px_32px_0_rgba(0,0,0,0.36)] border border-white/10 overflow-hidden p-16 flex flex-col items-center justify-center min-h-[400px]">
                <div class="relative w-32 h-32 mb-8">
                    <div id="proc-glow" class="absolute inset-0 blur-2xl rounded-full animate-pulse bg-sky-500/20"></div>
                    <svg class="w-full h-full rotate-[-90deg] relative z-10" viewBox="0 0 100 100">
                        <circle class="text-slate-800/50 stroke-current" strokeWidth="3" cx="50" cy="50" r="46" fill="transparent"></circle>
                        <circle 
                            id="proc-circle"
                            class="stroke-current transition-all duration-300 ease-out text-sky-400 drop-shadow-[0_0_8px_rgba(56,189,248,0.8)]" 
                            strokeWidth="3" strokeLinecap="round" cx="50" cy="50" r="46" fill="transparent"
                            strokeDasharray="0 289.02"
                        ></circle>
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center z-20">
                        <span id="proc-percent" class="text-2xl font-black text-white tracking-tighter">0%</span>
                    </div>
                </div>
                <h3 class="text-xl font-bold text-white mb-2 tracking-wide animate-pulse">変換中...</h3>
                <p id="proc-message" class="font-mono text-xs mb-8 text-sky-200/60">初期化中...</p>
                <button onclick="cancelProcessing()" class="text-slate-500 hover:text-white text-[10px] tracking-widest font-bold px-6 py-2 rounded-full hover:bg-white/10 border border-transparent hover:border-white/10 transition-all backdrop-blur-md">
                    キャンセル
                </button>
            </div>

            <!-- VIEW: COMPLETE -->
            <div id="view-complete" class="hidden bg-white/5 backdrop-blur-2xl rounded-[2.5rem] shadow-[0_8px_32px_0_rgba(0,0,0,0.36)] border border-white/10 overflow-hidden p-12 flex flex-col items-center justify-center min-h-[300px] animate-fade-in-up">
                <div id="comp-icon-container" class="w-16 h-16 bg-opacity-10 border bg-transparent rounded-full flex items-center justify-center mb-6 shadow-[0_0_20px_rgba(255,255,255,0.1)] border-sky-500/20 text-sky-400 shadow-sky-500/20">
                    <i data-lucide="check-circle-2" class="w-8 h-8"></i>
                </div>
                
                <h2 class="text-2xl font-bold text-white mb-1">ダウンロード完了</h2>
                
                <div id="comp-size-badge" class="hidden mb-6 flex items-center gap-2 text-xs font-mono bg-black/30 px-3 py-1 rounded-full border border-white/5">
                    <span class="text-slate-400">作成サイズ:</span>
                    <span id="comp-size-val" class="font-bold text-sky-300">0 MB</span>
                </div>

                <p class="text-slate-400 text-sm mb-8 text-center max-w-xs leading-relaxed">
                    ファイルが自動でダウンロードされました。
                </p>

                <div class="flex flex-col gap-3 w-full max-w-xs">
                    <button id="btn-manual-dl" class="w-full flex items-center justify-center gap-2 text-white font-bold py-3 px-6 rounded-xl transition-all shadow-lg hover:shadow-lg bg-sky-600 hover:bg-sky-500 hover:shadow-sky-500/30">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        手動でダウンロード
                    </button>
                    
                    <button onclick="resetApp()" class="w-full flex items-center justify-center gap-2 bg-white/5 hover:bg-white/10 text-slate-300 font-medium py-3 px-6 rounded-xl border border-white/5 transition-all">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        続けて変換
                    </button>
                </div>
            </div>

            <!-- VIEW: ERROR -->
            <div id="view-error" class="hidden bg-white/5 backdrop-blur-2xl rounded-[2.5rem] shadow-[0_8px_32px_0_rgba(0,0,0,0.36)] border border-white/10 overflow-hidden p-12 text-center space-y-6">
                <div class="w-16 h-16 bg-red-900/20 border border-red-500/20 text-red-500 rounded-full flex items-center justify-center mx-auto mb-2 shadow-[0_0_30px_rgba(239,68,68,0.1)]">
                    <i data-lucide="alert-circle" class="w-8 h-8"></i>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-slate-200">エラーが発生しました</h3>
                    <p id="error-msg" class="text-slate-400 text-sm mt-3 max-w-sm mx-auto bg-black/20 p-4 rounded-lg font-mono break-all border border-white/5">
                        Unknown Error
                    </p>
                </div>
                <button onclick="resetApp()" class="px-8 py-3 bg-white/10 text-white border border-white/10 rounded-xl hover:bg-white/20 transition-all font-medium shadow-lg">
                    戻る
                </button>
            </div>

        </div>
        
        <!-- Footer -->
        <div class="flex flex-col items-center justify-center space-y-2 pt-4 opacity-40 hover:opacity-100 transition-opacity">
            <div class="flex items-center gap-3 text-[10px] font-bold text-slate-500 tracking-[0.2em] uppercase">
                <div class="flex items-center gap-1">
                    <i data-lucide="zap" class="w-3 h-3"></i>
                    <span>Client-Side Only</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Application Logic -->
    <script>
        // State
        let currentQuality = 'medium';
        let currentFile = null;
        let generatedBlob = null;
        let generatedFileName = '';
        let isProcessingCanceled = false;

        // Theme Definitions
        const themes = {
            low: {
                color: 'emerald',
                blob1: 'bg-emerald-600/10', blob2: 'bg-teal-600/10',
                badgeText: 'Lightweight Mode',
                badgeClass: 'text-emerald-400/90', iconClass: 'text-emerald-400',
                gradient: 'from-emerald-400 to-teal-200',
                btnActive: 'bg-emerald-500/20 text-emerald-300 border-emerald-500/30',
                uploadIcon: 'text-emerald-400 group-hover:shadow-emerald-500/20',
                uploadBadge: 'border-emerald-500/30 bg-emerald-500 text-emerald-300',
                procGlow: 'bg-emerald-500/20',
                procText: 'text-emerald-400', procMsg: 'text-emerald-200/60',
                procShadow: 'drop-shadow-[0_0_8px_rgba(52,211,153,0.8)]',
                compIcon: 'border-emerald-500/20 text-emerald-400 shadow-emerald-500/20',
                compText: 'text-emerald-300',
                dlBtn: 'bg-emerald-600 hover:bg-emerald-500 hover:shadow-emerald-500/30'
            },
            medium: {
                color: 'sky',
                blob1: 'bg-sky-600/10', blob2: 'bg-indigo-600/10',
                badgeText: 'Standard Mode',
                badgeClass: 'text-sky-400/90', iconClass: 'text-sky-400',
                gradient: 'from-sky-400 to-indigo-200',
                btnActive: 'bg-sky-500/20 text-sky-300 border-sky-500/30',
                uploadIcon: 'text-sky-400 group-hover:shadow-sky-500/20',
                uploadBadge: 'border-sky-500/30 bg-sky-500 text-sky-300',
                procGlow: 'bg-sky-500/20',
                procText: 'text-sky-400', procMsg: 'text-sky-200/60',
                procShadow: 'drop-shadow-[0_0_8px_rgba(56,189,248,0.8)]',
                compIcon: 'border-sky-500/20 text-sky-400 shadow-sky-500/20',
                compText: 'text-sky-300',
                dlBtn: 'bg-sky-600 hover:bg-sky-500 hover:shadow-sky-500/30'
            },
            high: {
                color: 'fuchsia',
                blob1: 'bg-fuchsia-600/10', blob2: 'bg-purple-600/10',
                badgeText: 'High Quality Mode',
                badgeClass: 'text-fuchsia-400/90', iconClass: 'text-fuchsia-400',
                gradient: 'from-fuchsia-400 to-purple-200',
                btnActive: 'bg-fuchsia-500/20 text-fuchsia-300 border-fuchsia-500/30',
                uploadIcon: 'text-fuchsia-400 group-hover:shadow-fuchsia-500/20',
                uploadBadge: 'border-fuchsia-500/30 bg-fuchsia-500 text-fuchsia-300',
                procGlow: 'bg-fuchsia-500/20',
                procText: 'text-fuchsia-400', procMsg: 'text-fuchsia-200/60',
                procShadow: 'drop-shadow-[0_0_8px_rgba(232,121,249,0.8)]',
                compIcon: 'border-fuchsia-500/20 text-fuchsia-400 shadow-fuchsia-500/20',
                compText: 'text-fuchsia-300',
                dlBtn: 'bg-fuchsia-600 hover:bg-fuchsia-500 hover:shadow-fuchsia-500/30'
            }
        };

        // Initialize
        window.onload = () => {
            lucide.createIcons();
            setQuality('medium'); // Default
        };

        // UI Helpers
        function setQuality(q) {
            currentQuality = q;
            const t = themes[q];

            // Update Background
            updateClass('bg-blob-1', t.blob1, ['bg-emerald-600/10', 'bg-sky-600/10', 'bg-fuchsia-600/10']);
            updateClass('bg-blob-2', t.blob2, ['bg-teal-600/10', 'bg-indigo-600/10', 'bg-purple-600/10']);

            // Header
            document.getElementById('header-badge').innerText = t.badgeText;
            updateClass('header-badge', t.badgeClass, ['text-emerald-400/90', 'text-sky-400/90', 'text-fuchsia-400/90']);
            updateClass('header-icon', t.iconClass, ['text-emerald-400', 'text-sky-400', 'text-fuchsia-400']);
            updateClass('header-gradient', t.gradient, ['from-emerald-400', 'to-teal-200', 'from-sky-400', 'to-indigo-200', 'from-fuchsia-400', 'to-purple-200']);

            // Buttons
            resetBtnStyle('btn-q-low');
            resetBtnStyle('btn-q-medium');
            resetBtnStyle('btn-q-high');
            
            const activeBtn = document.getElementById(`btn-q-${q}`);
            activeBtn.className = `flex items-center gap-2 px-4 py-2 rounded-full text-xs font-bold transition-all border ${t.btnActive}`;

            // Upload Area
            updateClass('upload-icon-container', t.uploadIcon, ['text-emerald-400', 'shadow-emerald-500/20', 'text-sky-400', 'shadow-sky-500/20', 'text-fuchsia-400', 'shadow-fuchsia-500/20']);
            updateClass('upload-badge', t.uploadBadge, ['border-emerald-500/30', 'bg-emerald-500', 'text-emerald-300', 'border-sky-500/30', 'bg-sky-500', 'text-sky-300', 'border-fuchsia-500/30', 'bg-fuchsia-500', 'text-fuchsia-300']);
        
            // Processing View Styles
            updateClass('proc-glow', t.procGlow, ['bg-emerald-500/20', 'bg-sky-500/20', 'bg-fuchsia-500/20']);
            updateClass('proc-circle', t.procText, ['text-emerald-400', 'text-sky-400', 'text-fuchsia-400']);
            updateClass('proc-circle', t.procShadow, ['drop-shadow-[0_0_8px_rgba(52,211,153,0.8)]', 'drop-shadow-[0_0_8px_rgba(56,189,248,0.8)]', 'drop-shadow-[0_0_8px_rgba(232,121,249,0.8)]']);
            updateClass('proc-message', t.procMsg, ['text-emerald-200/60', 'text-sky-200/60', 'text-fuchsia-200/60']);

            // Complete View Styles
            updateClass('comp-icon-container', t.compIcon, ['border-emerald-500/20', 'text-emerald-400', 'shadow-emerald-500/20', 'border-sky-500/20', 'text-sky-400', 'shadow-sky-500/20', 'border-fuchsia-500/20', 'text-fuchsia-400', 'shadow-fuchsia-500/20']);
            updateClass('comp-size-val', t.compText, ['text-emerald-300', 'text-sky-300', 'text-fuchsia-300']);
            updateClass('btn-manual-dl', t.dlBtn, ['bg-emerald-600', 'hover:bg-emerald-500', 'hover:shadow-emerald-500/30', 'bg-sky-600', 'hover:bg-sky-500', 'hover:shadow-sky-500/30', 'bg-fuchsia-600', 'hover:bg-fuchsia-500', 'hover:shadow-fuchsia-500/30']);
        }

        function updateClass(id, add, removeList) {
            const el = document.getElementById(id);
            if (!el) return;
            removeList.forEach(c => {
                // Tailwind classes can be multiple words
                c.split(' ').forEach(cls => el.classList.remove(cls));
            });
            add.split(' ').forEach(cls => el.classList.add(cls));
        }

        function resetBtnStyle(id) {
            document.getElementById(id).className = "flex items-center gap-2 px-4 py-2 rounded-full text-xs font-bold transition-all border bg-white/5 text-slate-500 border-transparent hover:bg-white/10";
        }

        function switchView(viewId) {
            ['view-idle', 'view-processing', 'view-complete', 'view-error'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');
        }

        function updateProgress(percent, msg) {
            document.getElementById('proc-percent').innerText = `${percent}%`;
            document.getElementById('proc-message').innerText = msg;
            
            // Update circle stroke (approx 289 is circumference)
            const offset = 289.02 * (1 - percent / 100); // 100% means offset 0
            // Note: In SVG stroke-dasharray, actually to fill it we need to adjust
            // Original code used 289.02 * (percent/100) then 289.02.
            // Let's match the react logic: strokeDasharray={`${289.02 * (progress.percent / 100)} 289.02`}
            const filled = 289.02 * (percent / 100);
            document.getElementById('proc-circle').setAttribute('stroke-dasharray', `${filled} 289.02`);
        }

        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // --- Core Logic ---

        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const isPdf = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');
                
                if (isPdf) {
                    startProcessing(file);
                } else {
                    showError('PDFファイルのみ対応しています。(.pdf)');
                }
            }
            input.value = '';
        }

        async function startProcessing(file) {
            currentFile = file;
            isProcessingCanceled = false;
            switchView('view-processing');
            updateProgress(0, '設定を適用して読み込み中...');

            try {
                // Load PDF
                const arrayBuffer = await file.arrayBuffer();
                const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
                const pdf = await loadingTask.promise;
                const totalPages = pdf.numPages;

                if (totalPages === 0) throw new Error("ページ数が0です。");

                updateProgress(5, `スライド変換開始 (0/${totalPages})`);
                const images = [];

                // Quality Logic
                let targetScale = 1.5;
                let targetQuality = 0.8;
                
                if (currentQuality === 'high') {
                    targetScale = 2.0; targetQuality = 0.95;
                } else if (currentQuality === 'low') {
                    targetScale = 1.0; targetQuality = 0.6;
                }

                const qualityLabel = currentQuality === 'high' ? '高画質' : currentQuality === 'low' ? '軽量' : '標準';

                for (let i = 1; i <= totalPages; i++) {
                    if (isProcessingCanceled) break;
                    
                    try {
                        const page = await pdf.getPage(i);
                        const viewport = page.getViewport({ scale: targetScale });
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;

                        context.fillStyle = '#FFFFFF';
                        context.fillRect(0, 0, canvas.width, canvas.height);

                        await page.render({ canvasContext: context, viewport }).promise;
                        const dataUrl = canvas.toDataURL('image/jpeg', targetQuality);
                        
                        images.push({ dataUrl, width: viewport.width, height: viewport.height });
                        
                        // Cleanup
                        canvas.width = 0; canvas.height = 0;

                    } catch (e) {
                        throw new Error(`${i}ページ目の読み込みに失敗しました。`);
                    }

                    const currentPercent = 5 + Math.round((i / totalPages) * 75);
                    updateProgress(currentPercent, `変換中 (${i}/${totalPages}) - ${qualityLabel}`);
                    
                    // Allow UI update
                    await new Promise(r => setTimeout(r, 10));
                }

                if (isProcessingCanceled) {
                    resetApp();
                    return;
                }

                updateProgress(85, 'PowerPointファイル生成中...');
                
                if (typeof PptxGenJS === 'undefined') throw new Error("PPTX生成ライブラリエラー");

                const pptx = new PptxGenJS();
                const firstImg = images[0];
                const ratio = firstImg.width / firstImg.height;

                if (Math.abs(ratio - 16/9) < 0.1) pptx.layout = 'LAYOUT_16x9';
                else if (Math.abs(ratio - 4/3) < 0.1) pptx.layout = 'LAYOUT_4x3';
                else { pptx.defineLayout({ name: 'CUSTOM', width: 10, height: 10 / ratio }); pptx.layout = 'CUSTOM'; }

                for (const imgData of images) {
                    const slide = pptx.addSlide();
                    slide.addImage({ data: imgData.dataUrl, x: 0, y: 0, w: '100%', h: '100%' });
                }

                updateProgress(95, '最終書き出し中...');
                const blob = await pptx.write({ outputType: 'blob' });
                generatedBlob = blob;

                // File Name
                const suffix = currentQuality === 'high' ? '_hq' : currentQuality === 'low' ? '_light' : '_std';
                generatedFileName = `${currentFile.name.replace(/\.pdf$/i, '')}${suffix}.pptx`;
                
                // Update Complete View
                document.getElementById('comp-size-val').innerText = formatSize(blob.size);
                document.getElementById('comp-size-badge').classList.remove('hidden');
                
                // Manual Download Button Setup
                document.getElementById('btn-manual-dl').onclick = () => downloadBlob(generatedBlob, generatedFileName);

                // Auto Download
                downloadBlob(blob, generatedFileName);

                switchView('view-complete');

            } catch (err) {
                console.error(err);
                showError(err.message || '予期せぬエラーが発生しました。');
            }
        }

        function downloadBlob(blob, filename) {
            try {
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }, 100);
            } catch (e) {
                showError("自動ダウンロードに失敗しました。手動で保存してください。");
            }
        }

        function cancelProcessing() {
            isProcessingCanceled = true;
        }

        function resetApp() {
            currentFile = null;
            generatedBlob = null;
            switchView('view-idle');
        }

        function showError(msg) {
            document.getElementById('error-msg').innerText = msg;
            switchView('view-error');
        }

    </script>
</body>
</html>
